<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
    <meta charset="utf-8"/>
    <title>An Architect&#39;s View: deps.edn and monorepos II</title>
    
<meta name="keywords" content="diversity,strange loop,frege,clojure,polylith,boot,conferences,process,editors,java,personal,atom,tools.build,windows,monorepo,community,jdbc,conj,leiningen,javascript,observability,presentations,new relic,vs code,open source">

<meta name="description" content="A couple of months ago, I wrote about our use of deps.edn with our monorepo at work.
I&#39;ve updated that post to reflect changes we&#39;ve made recently and I&#39;m going to talk
in more detail about those changes in this post.">

<meta property="og:description" content="A couple of months ago, I wrote about our use of deps.edn with our monorepo at work.
I&#39;ve updated that post to reflect changes we&#39;ve made recently and I&#39;m going to talk
in more detail about those changes in this post.">

<meta property="og:url" content="https://corfield.org/blog/2021/04/21/deps-edn-monorepo-2/" />
<meta property="og:title" content="deps.edn and monorepos II" />
<meta property="og:type" content="article" />

    <link rel="canonical" href="https://corfield.org/blog/2021/04/21/deps-edn-monorepo-2/">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="//fonts.googleapis.com/css?family=Alegreya:400italic,700italic,400,700" rel="stylesheet"
          type="text/css">
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.0/css/bootstrap.min.css">
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.7.0/styles/default.min.css">
    <link href="/css/screen.css?1" rel="stylesheet" type="text/css" />
    <script src="//code.jquery.com/jquery-1.11.0.min.js"></script>
</head>
<body>

<nav class="navbar navbar-default">
    <div class="container">
        <div class="navbar-header right">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">An Architect&#39;s View</a>
        </div>
        <div id="navbar" class="navbar-collapse collapse right">
            <ul class="nav navbar-nav navbar-right">
                <li ><a href="/">Home</a></li>
                <li
                ><a href="/archives/">Archives</a></li>
                
                <li
                >
                <a href="/pages/presentations/">Presentations</a>
                </li>
                
                <li><a href="/atom.xml">RSS</a></li>
                <li><a rel="me" href="https://tech.lgbt/@seancorfield">tech.lgbt</a></li>
            </ul>
        </div><!--/.nav-collapse -->
    </div><!--/.container-fluid -->
</nav>


<div class="container">


    <div class="row">
        <div class="col-lg-9">
            <div id="content">
                
<div id="post">
    <div class="post-header">
    <div id="post-meta" class="row">
        <div class="col-lg-6">April 21, 2021</div>
        
    </div>
    <h2>deps.edn and monorepos II</h2>
</div>
<div>
    
    <p>A couple of months ago, I wrote about our use of <a href="/blog/2021/02/23/deps-edn-monorepo/"><code>deps.edn</code> with our monorepo</a> at work.
I've updated that post to reflect changes we've made recently and I'm going to talk
in more detail about those changes in this post.<!--more--></p><h3 id="the-monorepopolylith-series">The Monorepo/Polylith Series</h3><p><em>This blog post is part of an ongoing series following our experiences with our Clojure monorepo and our migration to Polylith:</em></p><ol><li><em><a href="https://corfield.org/blog/2021/02/23/deps-edn-monorepo/">deps.edn and monorepos</a></em></li><li><em><a href="https://corfield.org/blog/2021/04/21/deps-edn-monorepo-2/">deps.edn and monorepos II</a> (this post)</em></li><li><em><a href="https://corfield.org/blog/2021/06/06/deps-edn-monorepo-3/">deps.edn and monorepos III (Polylith)</a></em></li><li><em><a href="https://corfield.org/blog/2021/07/21/deps-edn-monorepo-4/">deps.edn and monorepos IV</a></em></li><li><em><a href="https://corfield.org/blog/2021/08/25/deps-edn-monorepo-5/">deps.edn and monorepos V (Polylith)</a></em></li><li><em><a href="https://corfield.org/blog/2021/10/01/deps-edn-monorepo-6/">deps.edn and monorepos VI (Polylith)</a></em></li><li><em><a href="https://corfield.org/blog/2021/10/13/deps-edn-monorepo-7/">deps.edn and monorepos VII (Polylith)</a></em></li><li><em><a href="https://corfield.org/blog/2021/11/28/deps-edn-monorepo-8/">deps.edn and monorepos VIII (Polylith)</a></em></li><li><em><a href="https://corfield.org/blog/2022/11/05/deps-edn-monorepo-9/">deps.edn and monorepos IX (Polylith)</a></em></li></ol><h2 id="part-ii">Part II</h2><p>The main change is that we have abandoned the use of a <code>:defaults</code> alias in the repo-level <code>deps.edn</code> file -- and the use of <code>:override-deps</code> to pin versions -- and now we specify versions explicitly in subprojects' <code>deps.edn</code> directly.</p><h2 id="pinning-dependencies">Pinning Dependencies</h2><p>We had originally focused on pinning dependency versions across the whole repo
because we had historically been doing this via <code>:exclusions</code> and additional
top-level dependencies, all the way back to when we used Leiningen. We had carried
this over into our Boot setup and then into our CLI / <code>deps.edn</code> setup, although
we lost the <code>:exclusions</code> at that point since <code>tools.deps.alpha</code> will use an
explicit top-level dependency as an override for any transitive version.
We knew that some of our subprojects had problems
with more recent versions of a few of our dependencies -- we had tried to update
some dependencies and ran into broken tests so we'd created a Jira ticket to
revisit the dependency "at some future date" and moved on -- but we hadn't dug
very deep into those problems because we had more important things to deal with
at the time.</p><p>Luckily, we work in a company that understands "technical debt" and is happy with
us creating tickets to track it whenever we identify it, and working on those
tickets is considered valuable, productive work, and is balanced against feature
work when prioritizing what we work on. Lately I've been digging into quite a bit
of that technical debt and so I finally spent some time identifying exactly which
subprojects are broken by which dependencies.</p><p>The two problematic ones have turned out to be <code>clj-http</code> and, no surprise, the
Jackson JSON libraries. I talked about our ongoing <a href="/blog/2021/03/25/little-things/">switch from <code>clj-http</code> to <code>http-kit</code></a> a month ago.
I've never bothered to dig into <em>why</em> more recent versions break several of our
file upload tests because I was happy to stay on 3.4.1 with a view to migrating
off that library anyway. With the Jackson library, it turned out that all of our
subprojects were fine with the most recent version, except for one that also
relies heavily on GraphQL and it turned out that 2.9.0 introduced changes in
how <code>null</code> was handled and those are breaking for that one subproject.</p><p>So we decided to pin that single subproject to version 2.8.11 (and 2.8.11.6) of
the Jackson libraries and let all of the other subprojects use more recent versions.
Because we still rely on the <code>:everything</code> alias in the repo-level <code>deps.edn</code> file
for our REPL expericence with the entire codebase,
we have Jackson pinned in that alias but when we run tests, those use the individual
subproject's dependencies and therefore the code is tested with whatever is the
natural transitive Jackson dependency -- apart from that one subproject which is
tested <em>and built into an uberjar</em> using the pinned 2.8.11 version.</p><h2 id="defaultsoverride-deps"><code>:defaults</code>/<code>:override-deps</code></h2><p>Although we'd settled on using an alias in the repo-level <code>deps.edn</code> file to
pin versions using <code>:override-deps</code>, as noted above it wasn't really necessary
for the vast majority of our subprojects.</p><p>There is another problem with this approach: any third-party tooling you use
with your monorepo has to be able to use this alias in order to analyze the
<code>deps.edn</code> files. For some tools, that's fine -- either they read those files
as pure EDN and don't care that a version is specified as <code>{}</code> or they have
a way to specify aliases to be used while processing those files. Even so,
it makes those tools harder to use, and it makes some tools impossible to use.</p><h3 id="polylith">Polylith</h3><p>I mentioned <a href="https://polylith.gitbook.io/">Polylith</a> in passing in the previous
article about our monorepo and I've spent quite a bit of time investigating it
since then. A new project landed on my plate at work and I decided to try out
Polylith, since I was very skeptical about it. Writing this new project as a
series of very small, independent, focused components was a good experience --
I plan to write a lot more about Polylith in the future -- but because of how
<a href="https://github.com/polyfy/polylith/tree/issue-66">Polylith currently works with the Clojure CLI and <code>deps.edn</code></a>,
there was no way to provide the <code>:defaults</code> alias and therefore no way to
have these new components depend on our existing subprojects (because the <code>{}</code>
version couldn't be resolved). In contrast, it was straightforward for code
in our existing subprojects to depend on these new Polylith <code>components</code>.</p><p>This was another nail in our use of <code>:defaults</code> and <code>:override-deps</code> (although
the creator of Polylith says that some way of pinning versions of dependencies
is under consideration).</p><h3 id="retiring-defaults">Retiring <code>:defaults</code></h3><p>We made the decision to retire our global <code>:defaults</code> alias and to propagate
the actual dependency versions down into the subprojects' <code>deps.edn</code> files.
This was also a good opportunity to remove dependencies that were actually
provided by other subprojects. In the earlier post about our monorepo, I
showed the <code>activator</code> subproject's <code>deps.edn</code> as having these dependencies:</p><pre><code class="clojure">{:deps
 {worldsingles/worldsingles {:local/root "../worldsingles"}
  ;; originally:
  camel-snake-kebab/camel-snake-kebab {}
  com.stuartsierra/component {}
  seancorfield/next.jdbc {}
  ;; 2021-04-21:
  camel-snake-kebab/camel-snake-kebab {:mvn/version "0.4.2"}
  com.stuartsierra/component {:mvn/version "1.0.0"}
  seancorfield/next.jdbc {:mvn/version "1.1.646"}
  }}
</code></pre><p>In reality, the <code>worldsingles</code> subproject already brought those dependencies
in, mostly via its own transitive dependencies, so <code>activator</code>'s <code>deps.edn</code>
file ended up looking like this:</p><pre><code class="clojure">{:deps
 {worldsingles/worldsingles {:local/root "../worldsingles"}}}
</code></pre><p>This was true for a number of other dependencies too, so in the end we
did not end up duplicating as many dependency declarations as I had
expected and the loss of the central version declaration -- in the
<code>:defaults</code> alias -- wasn't as painful as I had feared.</p><p>Interestingly, removing the pinned dependencies from the repo-level
<code>deps.edn</code> file and the superfluous dependencies from the subproject
<code>deps.edn</code> files also led to a reduction in size of our deployable
artifacts of up to 200K per JAR file -- so clearly several of the
explicit dependencies we had in place were not actually necessary
at all!</p><p>Another benefit of this change is that our new Polylith <code>components</code>
can now depend on our legacy subprojects while we continue to
refactor our code into smaller, more reusable pieces.</p><h2 id="current-status">Current Status</h2><p>At this point, we can actually work directly with many of our subprojects,
running <code>clojure</code> inside those subprojects and ignoring the
repo-level <code>deps.edn</code> file if we want.</p><p>It has also simplified our dev/test/build chain -- because we no longer
need to worry about always passing <code>:defaults</code> into all our tooling --
and by writing a small <code>:exec-fn</code> wrapper for
<a href="https://github.com/cognitect-labs/test-runner">Cognitect's <code>test-runner</code></a>
we can now specify directories to scan for tests as <code>:exec-args</code> in
our <code>:*-test</code> aliases and no longer need to specify <code>-d</code> options when
running tests (the limitation of <code>:main-opts</code> being that "last one wins"
when merging aliases, but <code>:exec-args</code> <em>do</em> merge across aliases).</p><p>We use <a href="https://github.com/liquidz/antq/">antq</a> for tracking outdated
dependencies and if you have a mix of versions in the <code>deps.edn</code> files
you ask it to analyze, it will correctly show outdated versions even
when some <code>deps.edn</code> files have the latest version -- so we haven't
lost any capability there by moving away from pinned versions.</p><p>And finally, as noted above, this paves the way for us to mix'n'match
our "legacy" subprojects with newer, Polylith-style <code>components</code> so that
it will be easier to push forward with Polylith and refactor older code
in a piecemeal manner rather than requiring "big bang" changes.</p><p>As before, if you have questions, find me on the <a href="https://clojurians.slack.com">Clojurians Slack</a>,
or just ask in the comments below.</p>
</div>

<div id="post-tags">
    <b>Tags: </b>
    
    <a href="/tags/clojure/">clojure</a>
    
    <a href="/tags/polylith/">polylith</a>
    
    <a href="/tags/monorepo/">monorepo</a>
    
</div>


    <div id="prev-next">
        
        <a href="/blog/2021/06/06/deps-edn-monorepo-3/">&laquo; deps.edn and monorepos III (Polylith)</a>
        
        
        <a class="right" href="/blog/2021/03/25/little-things/">It&#39;s the &quot;Little Things&quot;... &raquo;</a>
        
    </div>

    
    <div id="disqus_thread"></div>
    <script type="text/javascript">
        var disqus_config = function () {
            this.page.url = "https://corfield.org/blog/2021/04/21/deps-edn-monorepo-2/";
            this.page.identifier = "deps.edn and monorepos II";
        };
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//seancorfield.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    


</div>

            </div>
        </div>

        <div class="col-md-3">
            <div id="sidebar">
                <h3>About This Blog</h3>
                <p>Sean Corfield, Software Architect, offers his views on the world of software development.</p>
                <p class="smallprint">Masthead image &copy; Vernon Viehe.</p>
                
                
                <div id="recent">
                    <h3>Recent Posts</h3>
                    <ul>
                        
                        <li><a href="/blog/2022/11/05/deps-edn-monorepo-9/">deps.edn and monorepos IX (Polylith)</a></li>
                        
                        <li><a href="/blog/2022/10/30/social-media/">Social Media Revisited</a></li>
                        
                        <li><a href="/blog/2021/11/28/deps-edn-monorepo-8/">deps.edn and monorepos VIII (Polylith)</a></li>
                        
                        <li><a href="/blog/2021/11/14/clojure-doc/">The new clojure-doc web site</a></li>
                        
                        <li><a href="/blog/2021/11/10/social-media/">Social Media</a></li>
                        
                    </ul>
                </div>
                
                
                
                <h3>GitHub Repos</h3>
                <iframe src="https://github.com/sponsors/seancorfield/button" title="Sponsor seancorfield" height="35" width="116" style="border: 0;"></iframe>
                <ul id="gh_repos" class="smallprint">
                  <li class="loading">Status updating...</li>
                </ul>
                
                <a href="https://github.com/seancorfield">@seancorfield</a> on GitHub
                
                <script type="text/javascript">
                  $(document).ready(function(){
                      if (!window.jXHR){
                          var jxhr = document.createElement('script');
                          jxhr.type = 'text/javascript';
                          jxhr.src = 'https://corfield.org/js/libs/jXHR.js';
                          var s = document.getElementsByTagName('script')[0];
                          s.parentNode.insertBefore(jxhr, s);
                      }

                      github.showRepos({
                          user: 'seancorfield',
                          count: 6,
                          skip_forks: true,
                          target: '#gh_repos'
                      });
                  });
                </script>
                <script src="https://corfield.org/js/github.js" type="text/javascript"> </script>
                
                
                <div id="tags">
                    <h3>Tags</h3>
                    <ul>
                        
                        <li><a href="/tags/diversity/">diversity</a></li>
                        
                        <li><a href="/tags/strange loop/">strange loop</a></li>
                        
                        <li><a href="/tags/frege/">frege</a></li>
                        
                        <li><a href="/tags/clojure/">clojure</a></li>
                        
                        <li><a href="/tags/polylith/">polylith</a></li>
                        
                        <li><a href="/tags/boot/">boot</a></li>
                        
                        <li><a href="/tags/conferences/">conferences</a></li>
                        
                        <li><a href="/tags/process/">process</a></li>
                        
                        <li><a href="/tags/editors/">editors</a></li>
                        
                        <li><a href="/tags/java/">java</a></li>
                        
                        <li><a href="/tags/personal/">personal</a></li>
                        
                        <li><a href="/tags/atom/">atom</a></li>
                        
                        <li><a href="/tags/tools.build/">tools.build</a></li>
                        
                        <li><a href="/tags/windows/">windows</a></li>
                        
                        <li><a href="/tags/monorepo/">monorepo</a></li>
                        
                        <li><a href="/tags/community/">community</a></li>
                        
                        <li><a href="/tags/jdbc/">jdbc</a></li>
                        
                        <li><a href="/tags/conj/">conj</a></li>
                        
                        <li><a href="/tags/leiningen/">leiningen</a></li>
                        
                        <li><a href="/tags/javascript/">javascript</a></li>
                        
                        <li><a href="/tags/observability/">observability</a></li>
                        
                        <li><a href="/tags/presentations/">presentations</a></li>
                        
                        <li><a href="/tags/new relic/">new relic</a></li>
                        
                        <li><a href="/tags/vs code/">vs code</a></li>
                        
                        <li><a href="/tags/open source/">open source</a></li>
                        
                    </ul>
                </div>
                
            </div>
        </div>
    </div>
    <footer>Copyright &copy; 2022 Sean Corfield
        <p style="text-align: center;">Powered by <a href="https://cryogenweb.org">Cryogen</a></p></footer>
</div>
<script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.0/js/bootstrap.min.js"></script>
<script src="/js/highlight.pack.js" type="application/javascript"></script>
<script>hljs.initHighlightingOnLoad();</script>


</body>
</html>
