<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
    <meta charset="utf-8"/>
    <title>An Architect&#39;s View: deps.edn and monorepos VI (Polylith)</title>
    
<meta name="keywords" content="diversity,strange loop,frege,clojure,polylith,boot,conferences,process,editors,java,personal,atom,tools.build,windows,monorepo,community,jdbc,conj,leiningen,javascript,observability,presentations,new relic,vs code,open source">

<meta name="description" content="This is part of an ongoing series of blog posts about our ever-evolving use of the Clojure CLI,
deps.edn, and Polylith, with our monorepo at
World Singles Networks.">

<meta property="og:description" content="This is part of an ongoing series of blog posts about our ever-evolving use of the Clojure CLI,
deps.edn, and Polylith, with our monorepo at
World Singles Networks.">

<meta property="og:url" content="https://corfield.org/blog/2021/10/01/deps-edn-monorepo-6/" />
<meta property="og:title" content="deps.edn and monorepos VI (Polylith)" />
<meta property="og:type" content="article" />

    <link rel="canonical" href="https://corfield.org/blog/2021/10/01/deps-edn-monorepo-6/">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="//fonts.googleapis.com/css?family=Alegreya:400italic,700italic,400,700" rel="stylesheet"
          type="text/css">
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.0/css/bootstrap.min.css">
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.7.0/styles/default.min.css">
    <link href="/css/screen.css?1" rel="stylesheet" type="text/css" />
    <script src="//code.jquery.com/jquery-1.11.0.min.js"></script>
</head>
<body>

<nav class="navbar navbar-default">
    <div class="container">
        <div class="navbar-header right">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">An Architect&#39;s View</a>
        </div>
        <div id="navbar" class="navbar-collapse collapse right">
            <ul class="nav navbar-nav navbar-right">
                <li ><a href="/">Home</a></li>
                <li
                ><a href="/archives/">Archives</a></li>
                
                <li
                >
                <a href="/pages/presentations/">Presentations</a>
                </li>
                
                <li><a href="/atom.xml">RSS</a></li>
            </ul>
        </div><!--/.nav-collapse -->
    </div><!--/.container-fluid -->
</nav>


<div class="container">


    <div class="row">
        <div class="col-lg-9">
            <div id="content">
                
<div id="post">
    <div class="post-header">
    <div id="post-meta" class="row">
        <div class="col-lg-6">October 1, 2021</div>
        
    </div>
    <h2>deps.edn and monorepos VI (Polylith)</h2>
</div>
<div>
    
    <p>This is part of an ongoing series of blog posts about our ever-evolving use of the Clojure CLI,
<code>deps.edn</code>, and <a href="https://polylith.gitbook.io/">Polylith</a>, with our monorepo at
<a href="https://worldsinglesnetworks.com">World Singles Networks</a>.<!--more--></p><h3 id="the-monorepopolylith-series">The Monorepo/Polylith Series</h3><p><em>This blog post is part of an ongoing series following our experiences with our Clojure monorepo and our migration to Polylith:</em></p><ol><li><em><a href="https://corfield.org/blog/2021/02/23/deps-edn-monorepo/">deps.edn and monorepos</a></em></li><li><em><a href="https://corfield.org/blog/2021/04/21/deps-edn-monorepo-2/">deps.edn and monorepos II</a></em></li><li><em><a href="https://corfield.org/blog/2021/06/06/deps-edn-monorepo-3/">deps.edn and monorepos III (Polylith)</a></em></li><li><em><a href="https://corfield.org/blog/2021/07/21/deps-edn-monorepo-4/">deps.edn and monorepos IV</a></em></li><li><em><a href="https://corfield.org/blog/2021/08/25/deps-edn-monorepo-5/">deps.edn and monorepos V (Polylith)</a></em></li><li><em><a href="https://corfield.org/blog/2021/10/01/deps-edn-monorepo-6/">deps.edn and monorepos VI (Polylith)</a> (this post)</em></li><li><em><a href="https://corfield.org/blog/2021/10/13/deps-edn-monorepo-7/">deps.edn and monorepos VII (Polylith)</a></em></li><li><em><a href="https://corfield.org/blog/2021/11/28/deps-edn-monorepo-8/">deps.edn and monorepos VIII (Polylith)</a></em></li></ol><h2 id="part-vi">Part VI</h2><p>A lot of things have changed in the month (and a bit) since my last post in this series!
Our refactoring to Polylith has ramped back up, Polylith itself has had a new alpha release,
<code>tools.build</code> has continued to evolve nicely, and Java 17 has been released!</p><h3 id="polylith">Polylith</h3><p>We have refactored two more applications into <code>bases</code> and <code>projects</code> so about a quarter of
our codebase is Polylith-shaped now. The <code>poly deps</code> matrix no longer looks like a couple
of dozen unrelated <code>components</code> and now shows <code>bases</code> that actually depend on them!</p><p>The rewriting of our legacy (non-Clojure) code is now all going to Polylith bricks and as
we add new features to our dating platform, that is also going into Polylith as new bricks.</p><p>I mentioned back in March that we were
<a href="https://corfield.org/blog/2021/03/25/little-things/">switching from <code>clj-http</code> to <code>httpkit</code></a>
and that has been completed but it had the side effect that we have lost some telemetry in
New Relic around "web external" activity in our apps because it doesn't recognize <code>httpkit</code>'s
calls. The obvious thing at this point would be to switch to something like
<a href="https://github.com/gnarroway/hato"><code>hato</code></a> since that wraps Java's built-in <code>HttpClient</code>
functionality but, unfortunately, our legacy (non-Clojure) code still has to run on Java 8
and a lot of our Clojure code is shared between those apps and our "modern" (pure Clojure) apps
that run on more recent Java versions. I've been experimenting with <code>hato</code> in our test suite
code, since that is not shared with the legacy apps, and I've decided that this is a good
opportunity to leverage the "swappable implementation" feature of Polylith's <code>components</code>.
We're going to write an <code>http-client</code> interface (component) and have two implementations:
one using <code>httpkit</code> and one using <code>hato</code> and then our legacy apps can use the <code>httpkit</code>-based
implementation while our other apps can use the <code>hato</code>-based implementation, with the shared
code written against the common interface. We'll be able to switch <code>projects</code> over one at a time
if we want and we'll be able to develop against either implementation based on
<a href="https://github.com/polyfy/polylith#profile">profiles in Polylith</a>.</p><p>As noted above, Polylith has had a new alpha release which includes the work I talked about
in the last post to install <code>poly</code> as a Clojure CLI "tool" and to run per-project test suite
fixtures, as well as now being able to test individual bricks. Right now, we're running against
a SHA on master so that we can pick up a recent fix for those per-project test suite fixtures
and support for <code>data_readers.clj</code>.</p><h3 id="toolsbuild"><code>tools.build</code></h3><p>The <code>uber</code> task in <code>tools.build</code> has now reached parity with <code>depstar</code>'s functionality so
I have archived <code>depstar</code> to encourage people to switch over to <code>tools.build</code>. The log4j2
plugins cache merging from <code>depstar</code> has been spun out into a separate project that provides a
<a href="https://github.com/seancorfield/build-uber-log4j2-handler">log4j2 plugins cache conflict handler</a>
for <code>tools.build</code> (as of v0.4.0).</p><p>In addition to switching all of my OSS projects over to <code>tools.build</code> for JAR building,
I've been able to switch our monorepo at work over to it as well for uberjar building,
and I've abstracted a lot of the common code from various <code>build.clj</code> files to a new
library -- <a href="https://github.com/seancorfield/build-clj">build-clj</a> -- that lets you
simplify your <code>build.clj</code> file by providing sane defaults for a lot of the options
that <code>tools.build</code> offers. That <code>build-clj</code> library automatically includes the log4j2
conflict handler mentioned above.</p><p>I've also created a new, simpler tool for creating new CLI / <code>deps.edn</code> projects, based
on <code>tools.build</code> as I hinted at in part IV of this series:
<a href="https://github.com/seancorfield/deps-new">deps-new</a>. In particular, this new tool makes
it much, much easier to write your own project templates since they can be almost entirely
declarative with all the "heavy lifting" done by <code>tools.build</code> itself.</p><p>In part IV, I showed our <code>:build</code> alias which has now been simplified to this:</p><pre><code class="clojure">  :build
  {:deps {org.clojure/clojure {:mvn/version "1.11.0-alpha2"}

          io.github.seancorfield/build-clj {:git/tag "v0.4.0" :git/sha "54e39ae"
                                            :exclusions [org.slf4j/slf4j-nop]}
          ;; and local build tools:
          worldsingles/build {:local/root "build"}
          poly/artifact-uploader-cli {:local/root "bases/artifact-uploader-cli"}
          poly/artifact-uploader {:local/root "components/artifact-uploader"}}
   :ns-default build}
</code></pre><p>Gone is the dependency on <code>depstar</code>, and the <code>tools.build</code> dependency has been
replaced by my <code>build-clj</code> wrapper which has simplified our artifact building
code substantially (all my OSS projects also use <code>build-clj</code> -- see, for example,
<a href="https://github.com/seancorfield/next-jdbc/blob/develop/build.clj"><code>next.jdbc</code>'s <code>build.clj</code></a>).</p><p>Oh, and we're on Clojure 1.11 Alpha 2 in production (as of today).</p><h3 id="java-17">Java 17</h3><p>Even though our production systems run on Java 11 (except for our legacy apps), we've
been testing locally on Java 14, 15, and 16 so that we can be ready for the new LTS
release, Java 17. We've been testing on that for about a week now but we're still
blocked from upgrading production by lack of support for Java 17 in New Relic.</p><p>They just released <a href="https://docs.newrelic.com/docs/release-notes/agent-release-notes/java-release-notes/java-agent-730/">version 7.3.0</a>
with support for Java 16 (yesterday!), and they plan to support Java 17 fully in
<a href="https://github.com/newrelic/newrelic-java-agent/issues/384">version 7.4.0</a>.
See <a href="https://github.com/newrelic/newrelic-java-agent/issues/418">issue 418</a> for
the ongoing work, which is basically complete, but there are still
<a href="https://github.com/newrelic/newrelic-java-agent/issues?q=is%3Aissue+is%3Aopen+17">a few issues to shake out</a>
before they're fully there.</p><p>The timing is pretty good for us really since 7.4.0 will likely be available before
we go live on our new virtual server farm at the data center so we expect to roll
straight to Java 17, from Java 11, at that point.</p>
</div>

<div id="post-tags">
    <b>Tags: </b>
    
    <a href="/tags/clojure/">clojure</a>
    
    <a href="/tags/polylith/">polylith</a>
    
    <a href="/tags/tools.build/">tools.build</a>
    
    <a href="/tags/monorepo/">monorepo</a>
    
    <a href="/tags/new relic/">new relic</a>
    
</div>


    <div id="prev-next">
        
        <a href="/blog/2021/10/13/deps-edn-monorepo-7/">&laquo; deps.edn and monorepos VII (Polylith)</a>
        
        
        <a class="right" href="/blog/2021/08/25/deps-edn-monorepo-5/">deps.edn and monorepos V (Polylith) &raquo;</a>
        
    </div>

    
    <div id="disqus_thread"></div>
    <script type="text/javascript">
        var disqus_config = function () {
            this.page.url = "https://corfield.org/blog/2021/10/01/deps-edn-monorepo-6/";
            this.page.identifier = "deps.edn and monorepos VI (Polylith)";
        };
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//seancorfield.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    


</div>

            </div>
        </div>

        <div class="col-md-3">
            <div id="sidebar">
                <h3>About This Blog</h3>
                <p>Sean Corfield, Software Architect, offers his views on the world of software development.</p>
                <p class="smallprint">Masthead image &copy; Vernon Viehe.</p>
                
                
                <div id="recent">
                    <h3>Recent Posts</h3>
                    <ul>
                        
                        <li><a href="/blog/2021/11/28/deps-edn-monorepo-8/">deps.edn and monorepos VIII (Polylith)</a></li>
                        
                        <li><a href="/blog/2021/11/14/clojure-doc/">The new clojure-doc web site</a></li>
                        
                        <li><a href="/blog/2021/11/10/social-media/">Social Media</a></li>
                        
                        <li><a href="/blog/2021/10/13/deps-edn-monorepo-7/">deps.edn and monorepos VII (Polylith)</a></li>
                        
                        <li><a href="/blog/2021/10/01/deps-edn-monorepo-6/">deps.edn and monorepos VI (Polylith)</a></li>
                        
                    </ul>
                </div>
                
                
                
                <h3>GitHub Repos</h3>
                <iframe src="https://github.com/sponsors/seancorfield/button" title="Sponsor seancorfield" height="35" width="116" style="border: 0;"></iframe>
                <ul id="gh_repos" class="smallprint">
                  <li class="loading">Status updating...</li>
                </ul>
                
                <a href="https://github.com/seancorfield">@seancorfield</a> on GitHub
                
                <script type="text/javascript">
                  $(document).ready(function(){
                      if (!window.jXHR){
                          var jxhr = document.createElement('script');
                          jxhr.type = 'text/javascript';
                          jxhr.src = 'https://corfield.org/js/libs/jXHR.js';
                          var s = document.getElementsByTagName('script')[0];
                          s.parentNode.insertBefore(jxhr, s);
                      }

                      github.showRepos({
                          user: 'seancorfield',
                          count: 6,
                          skip_forks: true,
                          target: '#gh_repos'
                      });
                  });
                </script>
                <script src="https://corfield.org/js/github.js" type="text/javascript"> </script>
                
                
                <div id="tags">
                    <h3>Tags</h3>
                    <ul>
                        
                        <li><a href="/tags/diversity/">diversity</a></li>
                        
                        <li><a href="/tags/strange loop/">strange loop</a></li>
                        
                        <li><a href="/tags/frege/">frege</a></li>
                        
                        <li><a href="/tags/clojure/">clojure</a></li>
                        
                        <li><a href="/tags/polylith/">polylith</a></li>
                        
                        <li><a href="/tags/boot/">boot</a></li>
                        
                        <li><a href="/tags/conferences/">conferences</a></li>
                        
                        <li><a href="/tags/process/">process</a></li>
                        
                        <li><a href="/tags/editors/">editors</a></li>
                        
                        <li><a href="/tags/java/">java</a></li>
                        
                        <li><a href="/tags/personal/">personal</a></li>
                        
                        <li><a href="/tags/atom/">atom</a></li>
                        
                        <li><a href="/tags/tools.build/">tools.build</a></li>
                        
                        <li><a href="/tags/windows/">windows</a></li>
                        
                        <li><a href="/tags/monorepo/">monorepo</a></li>
                        
                        <li><a href="/tags/community/">community</a></li>
                        
                        <li><a href="/tags/jdbc/">jdbc</a></li>
                        
                        <li><a href="/tags/conj/">conj</a></li>
                        
                        <li><a href="/tags/leiningen/">leiningen</a></li>
                        
                        <li><a href="/tags/javascript/">javascript</a></li>
                        
                        <li><a href="/tags/observability/">observability</a></li>
                        
                        <li><a href="/tags/presentations/">presentations</a></li>
                        
                        <li><a href="/tags/new relic/">new relic</a></li>
                        
                        <li><a href="/tags/vs code/">vs code</a></li>
                        
                        <li><a href="/tags/open source/">open source</a></li>
                        
                    </ul>
                </div>
                
            </div>
        </div>
    </div>
    <footer>Copyright &copy; 2022 Sean Corfield
        <p style="text-align: center;">Powered by <a href="https://cryogenweb.org">Cryogen</a></p></footer>
</div>
<script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.0/js/bootstrap.min.js"></script>
<script src="/js/highlight.pack.js" type="application/javascript"></script>
<script>hljs.initHighlightingOnLoad();</script>


</body>
</html>
