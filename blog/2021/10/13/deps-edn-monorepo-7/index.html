<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
    <meta charset="utf-8"/>
    <title>An Architect&#39;s View: deps.edn and monorepos VII (Polylith)</title>
    
<meta name="keywords" content="diversity,strange loop,frege,clojure,polylith,boot,conferences,process,expectations,editors,java,joyride,personal,atom,tools.build,calva,windows,monorepo,community,jdbc,honeysql,portal,clojurists together,clojure-doc.org,conj,leiningen,javascript,observability,clojure-clr,presentations,new relic,watson,vs code,clj-commons,open source">

<meta name="description" content="This is part of an ongoing series of blog posts about our ever-evolving use of the Clojure CLI,
deps.edn, and Polylith, with our monorepo at
World Singles Networks.">

<meta property="og:description" content="This is part of an ongoing series of blog posts about our ever-evolving use of the Clojure CLI,
deps.edn, and Polylith, with our monorepo at
World Singles Networks.">

<meta property="og:url" content="https://corfield.org/blog/2021/10/13/deps-edn-monorepo-7/" />
<meta property="og:title" content="deps.edn and monorepos VII (Polylith)" />
<meta property="og:type" content="article" />

    <link rel="canonical" href="https://corfield.org/blog/2021/10/13/deps-edn-monorepo-7/">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="//fonts.googleapis.com/css?family=Alegreya:400italic,700italic,400,700" rel="stylesheet"
          type="text/css">
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.0/css/bootstrap.min.css">
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.7.0/styles/default.min.css">
    <link href="/css/screen.css?1" rel="stylesheet" type="text/css" />
    <script src="//code.jquery.com/jquery-1.11.0.min.js"></script>
</head>
<body>

<nav class="navbar navbar-default">
    <div class="container">
        <div class="navbar-header right">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">An Architect&#39;s View</a>
        </div>
        <div id="navbar" class="navbar-collapse collapse right">
            <ul class="nav navbar-nav navbar-right">
                <li ><a href="/">Home</a></li>
                <li
                ><a href="/archives/">Archives</a></li>
                
                <li
                >
                <a href="/pages/presentations/">Presentations</a>
                </li>
                
                <li><a href="/atom.xml">RSS</a></li>
                <li><a rel="me" href="https://tech.lgbt/@seancorfield">tech.lgbt</a></li>
            </ul>
        </div><!--/.nav-collapse -->
    </div><!--/.container-fluid -->
</nav>


<div class="container">


    <div class="row">
        <div class="col-lg-9">
            <div id="content">
                
<div id="post">
    <div class="post-header">
    <div id="post-meta" class="row">
        <div class="col-lg-6">October 13, 2021</div>
        
    </div>
    <h2>deps.edn and monorepos VII (Polylith)</h2>
</div>
<div>
    
    <p>This is part of an ongoing series of blog posts about our ever-evolving use of the Clojure CLI,
<code>deps.edn</code>, and <a href="https://polylith.gitbook.io/">Polylith</a>, with our monorepo at
<a href="https://worldsinglesnetworks.com">World Singles Networks</a>.<!--more--></p><h3 id="the-monorepopolylith-series">The Monorepo/Polylith Series</h3><p><em>This blog post is part of an ongoing series following our experiences with our Clojure monorepo and our migration to Polylith:</em></p><ol><li><em><a href="https://corfield.org/blog/2021/02/23/deps-edn-monorepo/">deps.edn and monorepos</a></em></li><li><em><a href="https://corfield.org/blog/2021/04/21/deps-edn-monorepo-2/">deps.edn and monorepos II</a></em></li><li><em><a href="https://corfield.org/blog/2021/06/06/deps-edn-monorepo-3/">deps.edn and monorepos III (Polylith)</a></em></li><li><em><a href="https://corfield.org/blog/2021/07/21/deps-edn-monorepo-4/">deps.edn and monorepos IV</a></em></li><li><em><a href="https://corfield.org/blog/2021/08/25/deps-edn-monorepo-5/">deps.edn and monorepos V (Polylith)</a></em></li><li><em><a href="https://corfield.org/blog/2021/10/01/deps-edn-monorepo-6/">deps.edn and monorepos VI (Polylith)</a></em></li><li><em><a href="https://corfield.org/blog/2021/10/13/deps-edn-monorepo-7/">deps.edn and monorepos VII (Polylith)</a> (this post)</em></li><li><em><a href="https://corfield.org/blog/2021/11/28/deps-edn-monorepo-8/">deps.edn and monorepos VIII (Polylith)</a></em></li><li><em><a href="https://corfield.org/blog/2022/11/05/deps-edn-monorepo-9/">deps.edn and monorepos IX (Polylith)</a></em></li><li><em><a href="https://corfield.org/blog/2022/12/07/deps-edn-monorepo-10/">deps.edn and monorepos X (Polylith)</a></em></li><li><em><a href="https://corfield.org/blog/2023/07/15/deps-edn-monorepo-11/">deps.edn and monorepos XI (Polylith)</a></em></li></ol><h2 id="part-vii">Part VII</h2><p>Another update, less than two weeks since the last one? Yes! Polylith has had
another alpha release with a very cool new feature added, we've completed our
first multi-implementation component in Polylith, and my development workflow
has had a major facelift with the latest releases from <a href="https://github.com/djblue/portal">Portal</a>!</p><h3 id="portal">Portal</h3><p>Let's start with the development workflow. I've been using <code>tap&gt;</code> in my development
workflow ever since it was added in the Clojure 1.10 prerelease cycle (Fall 2018 I think?).
When Cognitect's REBL came out, I loved what could be done with <code>datafy</code> and <code>nav</code>
and I also loved that it began to keep a <code>tap&gt;</code> history so you could browse through
all of that data. I used REBL for a long time before switching to
<a href="https://github.com/vlaaad/reveal">Reveal</a> and I've been enjoying using that on both macOS and Windows,
although having a WSLg-powered X window for Reveal is a much less pleasant experience
on Windows than the drop-snap behavior for fullscreen apps on macOS.</p><p>I'd looked at Portal fairly early on in its life and really didn't like that it
required a browser window for rendering but recently decided to take another look
because it was clear that Chris Badahdah (<a href="https://twitter.com/djblue_live">@djblue</a>)
had put in a lot of work since then. It turned out that Chris had been considering
a VS Code extension that encapsulated Portal into a webview panel and I got to test
an early <code>.vsix</code> file and, for me, that was a game changer! I no longer needed my
VS Code window to share space with either a JavaFX app or a browser: I could have
my data visualizer right there inside my editor and move it around like any
other tab, and have my editor be completely full screen on both macOS <em>and</em> Windows!</p><p>My core workflow with <code>tap&gt;</code> hasn't changed:
my <a href="https://github.com/seancorfield/dot-clojure">dot-clojure</a>
repo still has a <code>dev.clj</code> script that starts a Socket REPL and Rebel Readline etc
and my <a href="https://github.com/seancorfield/vscode-clover-setup">VS Code/Clover setup</a>
repo still has all the same key bindings and <code>config.cljs</code> file that sends all of
my evaluated code to <code>tap&gt;</code>. But now everything happens inside VS Code. I've added
a key binding (<code>ctrl-; shift-p</code>) that runs a <code>Portal start</code> task, which uses the
REPL to launch a Portal window inside VS Code (see the
<a href="https://marketplace.visualstudio.com/items?itemName=djblue.portal">Portal extension for VS Code</a>)
and adds a few extra custom commands to it (via a nice custom predicate/function API!).</p><p>Best of all, my workflow on Windows and macOS is now "identical" (modulo a few
VS Code key binding differences between platforms)!</p><h3 id="polylith--swappable-implementations">Polylith &amp; Swappable Implementations</h3><p>I talked about our plan to implement an <code>http-client</code> component in part 6 and
that work has been completed and merged in (and is currently in QA). Overall,
it was fairly straightforward to leverage
<a href="https://polylith.gitbook.io/poly/workflow/profile">Polylith's "profiles"</a>
and have two implementations of the same "interface" but integrating it into
our hybrid Polylith/legacy repo did have a couple of head-scratching moments.</p><p>We have <code>http-client-hato</code> and <code>http-client-httpkit</code>, both implementing the
<code>http-client</code> interface. We've added <code>:+default</code> and <code>:+httpkit</code> aliases to
our main <code>deps.edn</code> file -- following the Polylith profile naming convention --
so we are using the <a href="https://github.com/gnarroway/hato">Hato</a> implementation
by default for development/testing and for nearly all of our Polylith <code>projects</code>.
Our legacy apps use the <a href="https://http-kit.github.io/client.html">httpkit</a>
implementation. It's just a matter of which <code>:local/root</code> dependency you put
in your <code>deps.edn</code> file, so that's pretty slick.</p><p>You can run tests against either implementation:</p><ul><li><code>poly test :dev</code> uses the default, Hato-based, profile (the <code>:+default</code> alias),</li><li><code>poly test :dev +httpkit</code> uses the httpkit-based profile (the <code>:+httpkit</code> alias).</li></ul><p>Project-based tests use whichever <code>:local/root</code> dependency is declared in their
<code>deps.edn</code> -- we decided to keep one of them using the <code>httpkit</code> implementation
for now, just as a sanity check within the Polylith world.</p><p>Our hybrid repo also has <code>:everything</code> and <code>:runner</code> aliases which mirror
Polylith's <code>:dev</code> and <code>:test</code> aliases and we have added the Hato-based component
to the <code>:runner</code> alias so that our legacy test suite also uses Hato (and the
JDK11+ <code>HttpClient</code>).</p><p>What was head-scratching? Initially, I forgot to also add the Hato-based
component's <code>test</code> path to the <code>:runner</code> alias and just got a mysterious
<code>Namespace cannot be loaded</code> error from the Clojure CLI claiming that our
wrapper namespace for Cognitect's <code>test-runner</code> could not be found. Since the
"exec" functionality doesn't expose the underlying exception, that took a bit
of debugging.</p><p>In addition, Polylith currently doesn't support <code>:local/root</code> components
in profiles, only <code>:extra-paths</code> (see <a href="https://github.com/polyfy/polylith/issues/146">issue #146</a>),
so getting the profiles working was not as straightforward as I had expected.</p><p>And, finally, actually developing the alternate implementations was a bit
frustrating since I was trying to develop them side-by-side, rather than
creating a new implementation against an existing interface so I was
evaluating both components into the same REPL -- and they both had the
same namespaces (<code>ws.http-client.interface</code> and <code>ws.http-client.impl</code>).
After a while, I got into a good rhythm but it took a few attempts before
I settled into "eval <code>.impl</code>, eval <code>.interface</code>, eval other code and test,
switch to the other component and repeat". I learned a lot about both
httpkit and Java's <code>HttpClient</code> while I was doing this, especially around
how they handle async operations, thread pools, executors, and also how
they handle different SSL setups!</p><p>Overall, I would consider this a big win for Polylith: our shared code
is written against a functional interface, we can easily run all the
tests against either implementation with just a command-line flag, and
our projects can decide which implementation to use at build time!</p><h3 id="polylith-0213-alpha">Polylith 0.2.13-alpha</h3><p>And finally, on to the first item I mentioned: Polylith's new alpha release.</p><p>The main new feature is a very nice, interactive <code>shell</code> command that
provides auto-complete and history so you can just run <code>poly</code> and then
keep that open and work with Polylith without any startup overhead.</p><p>You can type <code>i&lt;TAB&gt;l&lt;TAB&gt;</code> and get the <code>info :loc</code> command. It also knows
how to offer auto-complete for your bricks and projects so you save a lot
of typing, and can easily scroll back and forth through your history
with the arrow keys.</p><p>One of the first things I did when I started working with the <code>poly</code> tool
was to write a primitive interactive wrapper so I didn't have to keep
running the entire process from scratch every time so I'm <strong>very</strong> pleased
to see this slick interactive mode in the core tool!</p><p>The second "big feature" is that the monolithic README for the tool
has been moved to the <a href="https://polylith.gitbook.io/poly"><code>poly</code> GitBook</a>
so it is much easier to navigate and much more pleasant to read. I think
this will be a big help for newcomers to Polylith: there's a huge amount
of documentation and a lot to learn before you can really become effective
with Polylith and its command-line tool and this is so much more digestible.</p><p>The final "big" change in this new release is that the project has switched
from a custom build/deploy pipeline, based on a mixture of <code>depstar</code> and Polylith's
own <code>deployer-cli</code> base and <code>deployer</code> component to using <code>tools.build</code>,
via my <a href="https://github.com/seancorfield/build-clj"><code>build-clj</code></a> wrapper library.
This helped iron out a couple of wrinkles in how monorepo-based artifacts
get built so <code>build-clj</code> now has a <code>:transitive</code> option for working with
<code>:local/root</code> components, such as Polylith relies heavily on.</p><p>This has also allowed for all <a href="https://polylith.gitbook.io/poly/workflow/build">build documentation</a>
to recommend using <code>tools.build</code> to create artifacts from Polylith repos,
instead of relying on <code>depstar</code>, which makes me happy.</p><p>See the <a href="https://github.com/polyfy/polylith/releases/tag/v0.2.13-alpha">0.2.13-alpha release notes</a>
for all the other changes in this release.</p><p>If you have a monorepo, or you are contemplating switching to a monorepo,
consider Polylith very seriously.</p>
</div>

<div id="post-tags">
    <b>Tags: </b>
    
    <a href="/tags/clojure/">clojure</a>
    
    <a href="/tags/polylith/">polylith</a>
    
    <a href="/tags/tools.build/">tools.build</a>
    
    <a href="/tags/monorepo/">monorepo</a>
    
    <a href="/tags/portal/">portal</a>
    
    <a href="/tags/vs%20code/">vs code</a>
    
</div>


    <div id="prev-next">
        
        <a href="/blog/2021/11/10/social-media/">&laquo; Social Media</a>
        
        
        <a class="right" href="/blog/2021/10/01/deps-edn-monorepo-6/">deps.edn and monorepos VI (Polylith) &raquo;</a>
        
    </div>

    
    <div id="disqus_thread"></div>
    <script type="text/javascript">
        var disqus_config = function () {
            this.page.url = "https://corfield.org/blog/2021/10/13/deps-edn-monorepo-7/";
            this.page.identifier = "deps.edn and monorepos VII (Polylith)";
        };
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//seancorfield.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    


</div>

            </div>
        </div>

        <div class="col-md-3">
            <div id="sidebar">
                <h3>About This Blog</h3>
                <p>Sean Corfield, Software Architect, offers his views on the world of software development.</p>
                <p class="smallprint">Masthead image &copy; Vernon Viehe.</p>
                
                
                <div id="recent">
                    <h3>Recent Posts</h3>
                    <ul>
                        
                        <li><a href="/blog/2024/11/09/conj-2024/">Clojure/conj 2024</a></li>
                        
                        <li><a href="/blog/2023/12/31/long-term-funding-6/">Long-Term Funding, Update #6</a></li>
                        
                        <li><a href="/blog/2023/10/31/long-term-funding-5/">Long-Term Funding, Update #5</a></li>
                        
                        <li><a href="/blog/2023/08/31/long-term-funding-4/">Long-Term Funding, Update #4</a></li>
                        
                        <li><a href="/blog/2023/07/15/deps-edn-monorepo-11/">deps.edn and monorepos XI (Polylith)</a></li>
                        
                    </ul>
                </div>
                
                
                
                <h3>GitHub Repos</h3>
                <iframe src="https://github.com/sponsors/seancorfield/button" title="Sponsor seancorfield" height="35" width="116" style="border: 0;"></iframe>
                <ul id="gh_repos" class="smallprint">
                  <li class="loading">Status updating...</li>
                </ul>
                
                <a href="https://github.com/seancorfield">@seancorfield</a> on GitHub
                
                <script type="text/javascript">
                  $(document).ready(function(){
                      if (!window.jXHR){
                          var jxhr = document.createElement('script');
                          jxhr.type = 'text/javascript';
                          jxhr.src = 'https://corfield.org/js/libs/jXHR.js';
                          var s = document.getElementsByTagName('script')[0];
                          s.parentNode.insertBefore(jxhr, s);
                      }

                      github.showRepos({
                          user: 'seancorfield',
                          count: 6,
                          skip_forks: true,
                          target: '#gh_repos'
                      });
                  });
                </script>
                <script src="https://corfield.org/js/github.js" type="text/javascript"> </script>
                
                
                <div id="tags">
                    <h3>Tags</h3>
                    <ul>
                        
                        <li><a href="/tags/diversity/">diversity</a></li>
                        
                        <li><a href="/tags/strange%20loop/">strange loop</a></li>
                        
                        <li><a href="/tags/frege/">frege</a></li>
                        
                        <li><a href="/tags/clojure/">clojure</a></li>
                        
                        <li><a href="/tags/polylith/">polylith</a></li>
                        
                        <li><a href="/tags/boot/">boot</a></li>
                        
                        <li><a href="/tags/conferences/">conferences</a></li>
                        
                        <li><a href="/tags/process/">process</a></li>
                        
                        <li><a href="/tags/expectations/">expectations</a></li>
                        
                        <li><a href="/tags/editors/">editors</a></li>
                        
                        <li><a href="/tags/java/">java</a></li>
                        
                        <li><a href="/tags/joyride/">joyride</a></li>
                        
                        <li><a href="/tags/personal/">personal</a></li>
                        
                        <li><a href="/tags/atom/">atom</a></li>
                        
                        <li><a href="/tags/tools.build/">tools.build</a></li>
                        
                        <li><a href="/tags/calva/">calva</a></li>
                        
                        <li><a href="/tags/windows/">windows</a></li>
                        
                        <li><a href="/tags/monorepo/">monorepo</a></li>
                        
                        <li><a href="/tags/community/">community</a></li>
                        
                        <li><a href="/tags/jdbc/">jdbc</a></li>
                        
                        <li><a href="/tags/honeysql/">honeysql</a></li>
                        
                        <li><a href="/tags/portal/">portal</a></li>
                        
                        <li><a href="/tags/clojurists%20together/">clojurists together</a></li>
                        
                        <li><a href="/tags/clojure-doc.org/">clojure-doc.org</a></li>
                        
                        <li><a href="/tags/conj/">conj</a></li>
                        
                        <li><a href="/tags/leiningen/">leiningen</a></li>
                        
                        <li><a href="/tags/javascript/">javascript</a></li>
                        
                        <li><a href="/tags/observability/">observability</a></li>
                        
                        <li><a href="/tags/clojure-clr/">clojure-clr</a></li>
                        
                        <li><a href="/tags/presentations/">presentations</a></li>
                        
                        <li><a href="/tags/new%20relic/">new relic</a></li>
                        
                        <li><a href="/tags/watson/">watson</a></li>
                        
                        <li><a href="/tags/vs%20code/">vs code</a></li>
                        
                        <li><a href="/tags/clj-commons/">clj-commons</a></li>
                        
                        <li><a href="/tags/open%20source/">open source</a></li>
                        
                    </ul>
                </div>
                
            </div>
        </div>
    </div>
    <footer>Copyright &copy; 2024 Sean Corfield
        <p style="text-align: center;">Powered by <a href="https://cryogenweb.org">Cryogen</a></p></footer>
</div>
<script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.0/js/bootstrap.min.js"></script>
<script src="/js/highlight.pack.js" type="application/javascript"></script>
<script>hljs.initHighlightingOnLoad();</script>


</body>
</html>
