<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
    <meta charset="utf-8"/>
    <title>An Architect&#39;s View: deps.edn and monorepos VIII (Polylith)</title>
    
<meta name="keywords" content="diversity,strange loop,frege,clojure,polylith,boot,conferences,process,editors,java,personal,atom,tools.build,windows,monorepo,community,jdbc,conj,leiningen,javascript,observability,presentations,new relic,vs code,open source">

<meta name="description" content="This is part of an ongoing series of blog posts about our ever-evolving use of the Clojure CLI,
deps.edn, and Polylith, with our monorepo at
World Singles Networks.">

<meta property="og:description" content="This is part of an ongoing series of blog posts about our ever-evolving use of the Clojure CLI,
deps.edn, and Polylith, with our monorepo at
World Singles Networks.">

<meta property="og:url" content="https://corfield.org/blog/2021/11/28/deps-edn-monorepo-8/" />
<meta property="og:title" content="deps.edn and monorepos VIII (Polylith)" />
<meta property="og:type" content="article" />

    <link rel="canonical" href="https://corfield.org/blog/2021/11/28/deps-edn-monorepo-8/">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="//fonts.googleapis.com/css?family=Alegreya:400italic,700italic,400,700" rel="stylesheet"
          type="text/css">
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.0/css/bootstrap.min.css">
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.7.0/styles/default.min.css">
    <link href="/css/screen.css?1" rel="stylesheet" type="text/css" />
    <script src="//code.jquery.com/jquery-1.11.0.min.js"></script>
</head>
<body>

<nav class="navbar navbar-default">
    <div class="container">
        <div class="navbar-header right">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">An Architect&#39;s View</a>
        </div>
        <div id="navbar" class="navbar-collapse collapse right">
            <ul class="nav navbar-nav navbar-right">
                <li ><a href="/">Home</a></li>
                <li
                ><a href="/archives/">Archives</a></li>
                
                <li
                >
                <a href="/pages/presentations/">Presentations</a>
                </li>
                
                <li><a href="/atom.xml">RSS</a></li>
                <li><a rel="me" href="https://tech.lgbt/@seancorfield">tech.lgbt</a></li>
            </ul>
        </div><!--/.nav-collapse -->
    </div><!--/.container-fluid -->
</nav>


<div class="container">


    <div class="row">
        <div class="col-lg-9">
            <div id="content">
                
<div id="post">
    <div class="post-header">
    <div id="post-meta" class="row">
        <div class="col-lg-6">November 28, 2021</div>
        
    </div>
    <h2>deps.edn and monorepos VIII (Polylith)</h2>
</div>
<div>
    
    <p>This is part of an ongoing series of blog posts about our ever-evolving use of the Clojure CLI,
<code>deps.edn</code>, and <a href="https://polylith.gitbook.io/">Polylith</a>, with our monorepo at
<a href="https://worldsinglesnetworks.com">World Singles Networks</a>.<!--more--></p><h3 id="the-monorepopolylith-series">The Monorepo/Polylith Series</h3><p><em>This blog post is part of an ongoing series following our experiences with our Clojure monorepo and our migration to Polylith:</em></p><ol><li><em><a href="https://corfield.org/blog/2021/02/23/deps-edn-monorepo/">deps.edn and monorepos</a></em></li><li><em><a href="https://corfield.org/blog/2021/04/21/deps-edn-monorepo-2/">deps.edn and monorepos II</a></em></li><li><em><a href="https://corfield.org/blog/2021/06/06/deps-edn-monorepo-3/">deps.edn and monorepos III (Polylith)</a></em></li><li><em><a href="https://corfield.org/blog/2021/07/21/deps-edn-monorepo-4/">deps.edn and monorepos IV</a></em></li><li><em><a href="https://corfield.org/blog/2021/08/25/deps-edn-monorepo-5/">deps.edn and monorepos V (Polylith)</a></em></li><li><em><a href="https://corfield.org/blog/2021/10/01/deps-edn-monorepo-6/">deps.edn and monorepos VI (Polylith)</a></em></li><li><em><a href="https://corfield.org/blog/2021/10/13/deps-edn-monorepo-7/">deps.edn and monorepos VII (Polylith)</a></em></li><li><em><a href="https://corfield.org/blog/2021/11/28/deps-edn-monorepo-8/">deps.edn and monorepos VIII (Polylith)</a> (this post)</em></li></ol><h2 id="part-viii">Part VIII</h2><p>It's been a month and a half since the last update so I figured an update was due, although I don't
really feel like I have much to report.</p><h3 id="new-relic">New Relic</h3><p>New Relic finally released a version of their Java Agent that is compatible with JDK 17
(<a href="https://docs.newrelic.com/docs/release-notes/agent-release-notes/java-release-notes/java-agent-740/">7.4.0 on October 28th</a>)
so we are finally rolling JDK 17 out into production. Early signs are good: with no
changes in configuration at all it looks like the G1 collector has become a bit more aggressive and,
although we saw marginally higher CPU usage for GC for the first few days (and
marginally lower throughput), now that we've been running for about a week, it
looks like GC has settled back down (to ~0.1% of CPU), throughput has settled
back down, and overall memory usage is lower with garbage being collected more
aggressively than on JDK 11. We're planning to roll more processes over to JDK 17
this week and if things continue to go smoothly, we'll start experimenting with
ZGC since several people have had good things to say about that.</p><h2 id="toolsbuild"><code>tools.build</code></h2><p>This library has seen several new releases since my last update and we have
now replaced all of the <code>ant</code> / <code>build.xml</code> / <code>bash</code> scripts around our "modern"
(Clojure) apps by switching from <code>.tar.gz</code> files built by the latter to <code>.zip</code>
files built by the former. They're about 50% larger but bandwidth and disk
space really aren't issues these days and having "everything" controllable via
a single <code>build.clj</code> script, which we can use from the REPL, simplifies that
last piece of our build/deploy chain.</p><p>Our legacy (non-Clojure) apps still rely on <code>ant</code> / <code>build.xml</code> / <code>bash</code> scripts
but the rewrite continues aggressively so I expect to ditch that in 2022!</p><h3 id="automating-builds">Automating Builds</h3><p>On the subject of automation and <code>tools.build</code>, I finally bit the bullet and
updated both <a href="https://github.com/seancorfield/next-jdbc"><code>next.jdbc</code></a> and
<a href="https://github.com/seancorfield/honeysql"><code>honeysql</code></a> to automatically,
test, build, and deploy, full "release" JARs to Clojars whenever I cut a
new release on GitHub (effectively whenever I push a new tag that starts with <code>v</code>).
This removes the last manual step that I was performing with these libraries
when making a new release.</p><h2 id="clojure-cli-and-toolsdepsalpha">Clojure CLI (and <code>tools.deps.alpha</code>)</h2><p>These have also had several new releases since my last update. There is now
a very nice <code>clojure -X:deps list</code> command that shows a sorted list of the
actual resolved dependencies and versions. In addition, the long-standing
issue of <code>:local/root</code> deps becoming stale and not recomputed has been
addressed, reducing the need for <code>-Sforce</code> in many situations (especially
in monorepos, such as you have with Polylith!).</p><h2 id="polylith">Polylith</h2><p>Nothing specific to report here, except that I have declared Fridays to
be "refactoring Fridays" for a while at work so I can more aggressively
refactor our existing subprojects into <code>components</code> (and <code>bases</code>) and
expand the leverage that incremental testing provides, via Polylith.</p><p>We're at 18 projects, 6 bases, 35 components, and just shy of 26k lines
of our production code using Polylith now (out of just over 96k lines).</p><h2 id="other-important-releases">Other Important Releases</h2><p>In closing, I want to call out <a href="https://clojure.org/releases/devchangelog#v1.11.0-alpha3">Clojure 1.11 Alpha 3</a>
which has a number of convenience features (and bug fixes). We have Alpha 3 in QA
and we're already using <code>parse-long</code>, <code>parse-double</code>, and <code>random-uuid</code> (we'll
probably start using the new <code>clojure.java.math</code> namespace next week). We have
had Alpha 2 in production for a couple of months and I expect we'll have Alpha
3 in production next week.</p><p>In addition, the <a href="https://github.com/rm-hull/nvd-clojure/">National Vulnerability Database dependency-checker library</a>
has merged the Pull Request I submitted to allow it to be installed as a CLI "tool"
so you can now do:</p><pre><code class="bash">$ clojure -Ttools install nvd-clojure/nvd-clojure '{:mvn/version "RELEASE"}' :as nvd

$ clojure -Tnvd nvd.task/check :classpath '"'$(clojure -Spath)'"'
# or with aliases to pull in dependencies:
$ clojure -Tnvd nvd.task/check :classpath '"'$(clojure -Spath -A:any:aliases)'"'
</code></pre><p>This will highlight any security vulnerabilities you may have in your dependencies
so it's definitely worthwhile to install and run this tool on all of your projects!</p>
</div>

<div id="post-tags">
    <b>Tags: </b>
    
    <a href="/tags/clojure/">clojure</a>
    
    <a href="/tags/polylith/">polylith</a>
    
    <a href="/tags/tools.build/">tools.build</a>
    
    <a href="/tags/monorepo/">monorepo</a>
    
    <a href="/tags/new relic/">new relic</a>
    
</div>


    <div id="prev-next">
        
        <a href="/blog/2022/10/30/social-media/">&laquo; Social Media Revisited</a>
        
        
        <a class="right" href="/blog/2021/11/14/clojure-doc/">The new clojure-doc web site &raquo;</a>
        
    </div>

    
    <div id="disqus_thread"></div>
    <script type="text/javascript">
        var disqus_config = function () {
            this.page.url = "https://corfield.org/blog/2021/11/28/deps-edn-monorepo-8/";
            this.page.identifier = "deps.edn and monorepos VIII (Polylith)";
        };
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//seancorfield.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    


</div>

            </div>
        </div>

        <div class="col-md-3">
            <div id="sidebar">
                <h3>About This Blog</h3>
                <p>Sean Corfield, Software Architect, offers his views on the world of software development.</p>
                <p class="smallprint">Masthead image &copy; Vernon Viehe.</p>
                
                
                <div id="recent">
                    <h3>Recent Posts</h3>
                    <ul>
                        
                        <li><a href="/blog/2022/10/30/social-media/">Social Media Revisited</a></li>
                        
                        <li><a href="/blog/2021/11/28/deps-edn-monorepo-8/">deps.edn and monorepos VIII (Polylith)</a></li>
                        
                        <li><a href="/blog/2021/11/14/clojure-doc/">The new clojure-doc web site</a></li>
                        
                        <li><a href="/blog/2021/11/10/social-media/">Social Media</a></li>
                        
                        <li><a href="/blog/2021/10/13/deps-edn-monorepo-7/">deps.edn and monorepos VII (Polylith)</a></li>
                        
                    </ul>
                </div>
                
                
                
                <h3>GitHub Repos</h3>
                <iframe src="https://github.com/sponsors/seancorfield/button" title="Sponsor seancorfield" height="35" width="116" style="border: 0;"></iframe>
                <ul id="gh_repos" class="smallprint">
                  <li class="loading">Status updating...</li>
                </ul>
                
                <a href="https://github.com/seancorfield">@seancorfield</a> on GitHub
                
                <script type="text/javascript">
                  $(document).ready(function(){
                      if (!window.jXHR){
                          var jxhr = document.createElement('script');
                          jxhr.type = 'text/javascript';
                          jxhr.src = 'https://corfield.org/js/libs/jXHR.js';
                          var s = document.getElementsByTagName('script')[0];
                          s.parentNode.insertBefore(jxhr, s);
                      }

                      github.showRepos({
                          user: 'seancorfield',
                          count: 6,
                          skip_forks: true,
                          target: '#gh_repos'
                      });
                  });
                </script>
                <script src="https://corfield.org/js/github.js" type="text/javascript"> </script>
                
                
                <div id="tags">
                    <h3>Tags</h3>
                    <ul>
                        
                        <li><a href="/tags/diversity/">diversity</a></li>
                        
                        <li><a href="/tags/strange loop/">strange loop</a></li>
                        
                        <li><a href="/tags/frege/">frege</a></li>
                        
                        <li><a href="/tags/clojure/">clojure</a></li>
                        
                        <li><a href="/tags/polylith/">polylith</a></li>
                        
                        <li><a href="/tags/boot/">boot</a></li>
                        
                        <li><a href="/tags/conferences/">conferences</a></li>
                        
                        <li><a href="/tags/process/">process</a></li>
                        
                        <li><a href="/tags/editors/">editors</a></li>
                        
                        <li><a href="/tags/java/">java</a></li>
                        
                        <li><a href="/tags/personal/">personal</a></li>
                        
                        <li><a href="/tags/atom/">atom</a></li>
                        
                        <li><a href="/tags/tools.build/">tools.build</a></li>
                        
                        <li><a href="/tags/windows/">windows</a></li>
                        
                        <li><a href="/tags/monorepo/">monorepo</a></li>
                        
                        <li><a href="/tags/community/">community</a></li>
                        
                        <li><a href="/tags/jdbc/">jdbc</a></li>
                        
                        <li><a href="/tags/conj/">conj</a></li>
                        
                        <li><a href="/tags/leiningen/">leiningen</a></li>
                        
                        <li><a href="/tags/javascript/">javascript</a></li>
                        
                        <li><a href="/tags/observability/">observability</a></li>
                        
                        <li><a href="/tags/presentations/">presentations</a></li>
                        
                        <li><a href="/tags/new relic/">new relic</a></li>
                        
                        <li><a href="/tags/vs code/">vs code</a></li>
                        
                        <li><a href="/tags/open source/">open source</a></li>
                        
                    </ul>
                </div>
                
            </div>
        </div>
    </div>
    <footer>Copyright &copy; 2022 Sean Corfield
        <p style="text-align: center;">Powered by <a href="https://cryogenweb.org">Cryogen</a></p></footer>
</div>
<script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.0/js/bootstrap.min.js"></script>
<script src="/js/highlight.pack.js" type="application/javascript"></script>
<script>hljs.initHighlightingOnLoad();</script>


</body>
</html>
