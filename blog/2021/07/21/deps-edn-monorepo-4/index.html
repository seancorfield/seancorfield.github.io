<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
    <meta charset="utf-8"/>
    <title>An Architect&#39;s View: deps.edn and monorepos IV</title>
    
<meta name="keywords" content="diversity,strange loop,frege,clojure,polylith,boot,conferences,process,editors,java,joyride,personal,atom,tools.build,calva,windows,monorepo,community,jdbc,honeysql,portal,clojurists together,clojure-doc.org,conj,leiningen,javascript,observability,clojure-clr,presentations,new relic,vs code,open source">

<meta name="description" content="This is part of an ongoing series of blog posts about our ever-evolving use of the Clojure CLI,
deps.edn, and Polylith, with our monorepo at
World Singles Networks.">

<meta property="og:description" content="This is part of an ongoing series of blog posts about our ever-evolving use of the Clojure CLI,
deps.edn, and Polylith, with our monorepo at
World Singles Networks.">

<meta property="og:url" content="https://corfield.org/blog/2021/07/21/deps-edn-monorepo-4/" />
<meta property="og:title" content="deps.edn and monorepos IV" />
<meta property="og:type" content="article" />

    <link rel="canonical" href="https://corfield.org/blog/2021/07/21/deps-edn-monorepo-4/">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="//fonts.googleapis.com/css?family=Alegreya:400italic,700italic,400,700" rel="stylesheet"
          type="text/css">
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.0/css/bootstrap.min.css">
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.7.0/styles/default.min.css">
    <link href="/css/screen.css?1" rel="stylesheet" type="text/css" />
    <script src="//code.jquery.com/jquery-1.11.0.min.js"></script>
</head>
<body>

<nav class="navbar navbar-default">
    <div class="container">
        <div class="navbar-header right">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">An Architect&#39;s View</a>
        </div>
        <div id="navbar" class="navbar-collapse collapse right">
            <ul class="nav navbar-nav navbar-right">
                <li ><a href="/">Home</a></li>
                <li
                ><a href="/archives/">Archives</a></li>
                
                <li
                >
                <a href="/pages/presentations/">Presentations</a>
                </li>
                
                <li><a href="/atom.xml">RSS</a></li>
                <li><a rel="me" href="https://tech.lgbt/@seancorfield">tech.lgbt</a></li>
            </ul>
        </div><!--/.nav-collapse -->
    </div><!--/.container-fluid -->
</nav>


<div class="container">


    <div class="row">
        <div class="col-lg-9">
            <div id="content">
                
<div id="post">
    <div class="post-header">
    <div id="post-meta" class="row">
        <div class="col-lg-6">July 24, 2021</div>
        
    </div>
    <h2>deps.edn and monorepos IV</h2>
</div>
<div>
    
    <p>This is part of an ongoing series of blog posts about our ever-evolving use of the Clojure CLI,
<code>deps.edn</code>, and <a href="https://polylith.gitbook.io/">Polylith</a>, with our monorepo at
<a href="https://worldsinglesnetworks.com">World Singles Networks</a>.<!--more--></p><h3 id="the-monorepopolylith-series">The Monorepo/Polylith Series</h3><p><em>This blog post is part of an ongoing series following our experiences with our Clojure monorepo and our migration to Polylith:</em></p><ol><li><em><a href="https://corfield.org/blog/2021/02/23/deps-edn-monorepo/">deps.edn and monorepos</a></em></li><li><em><a href="https://corfield.org/blog/2021/04/21/deps-edn-monorepo-2/">deps.edn and monorepos II</a></em></li><li><em><a href="https://corfield.org/blog/2021/06/06/deps-edn-monorepo-3/">deps.edn and monorepos III (Polylith)</a></em></li><li><em><a href="https://corfield.org/blog/2021/07/21/deps-edn-monorepo-4/">deps.edn and monorepos IV</a> (this post)</em></li><li><em><a href="https://corfield.org/blog/2021/08/25/deps-edn-monorepo-5/">deps.edn and monorepos V (Polylith)</a></em></li><li><em><a href="https://corfield.org/blog/2021/10/01/deps-edn-monorepo-6/">deps.edn and monorepos VI (Polylith)</a></em></li><li><em><a href="https://corfield.org/blog/2021/10/13/deps-edn-monorepo-7/">deps.edn and monorepos VII (Polylith)</a></em></li><li><em><a href="https://corfield.org/blog/2021/11/28/deps-edn-monorepo-8/">deps.edn and monorepos VIII (Polylith)</a></em></li><li><em><a href="https://corfield.org/blog/2022/11/05/deps-edn-monorepo-9/">deps.edn and monorepos IX (Polylith)</a></em></li><li><em><a href="https://corfield.org/blog/2022/12/07/deps-edn-monorepo-10/">deps.edn and monorepos X (Polylith)</a></em></li><li><em><a href="https://corfield.org/blog/2023/07/15/deps-edn-monorepo-11/">deps.edn and monorepos XI (Polylith)</a></em></li></ol><h2 id="part-iv">Part IV</h2><p>Since <a href="/blog/2021/06/06/deps-edn-monorepo-3/">last month's post</a>, we've created Polylith <code>projects</code>
for each of our deployable artifacts, as well as refactoring all of our cron job tasks into a new
base called <code>batch-jobs</code>. We now have 16 <code>projects</code>, 3 <code>bases</code>, and 23 <code>components</code>. This has
nicely separated the actual artifacts we build from the code we use to build them, providing a
clear "bill of materials" for each artifact (as a <code>deps.edn</code> file) and now we can build each artifact with:</p><pre><code class="bash">cd projects/&lt;artifact&gt;
clojure -X:uberjar
</code></pre><p>We still have the ability to run a single REPL with all our code and tests, and we also
have the ability to run incremental tests on <code>bases</code>, <code>components</code>, and <code>projects</code> via
the <code>poly</code> tool. We're looking forward to having incremental testing across the whole
codebase, once we have refactored everything -- but that is definitely a ways off.</p><h2 id="a-clojure-build-script">A Clojure Build Script</h2><p>The other big change we've made in the last month is something we've been talking about
internally, on and off, for a long time: switching away from an ad hoc set of bash scripts
that manage our test/build/deploy processes and instead having a single Clojure script
that orchestrates all of that. We've had Clojure scripts for many parts of that pipeline
for a long time but we've never made the jump to running those scripts from Clojure itself.
With the knowledge that <a href="https://github.com/clojure/tools.build"><code>tools.build</code></a> was on the
way, this seems like a good time to do that last leg of the work.</p><p>We've run our database migrations via Clojure for years. Our "cold start" to stand up a
dev/test environment involves two sets of database migrations, an Elastic Search setup
(for indices), and a "publishing" step to take dev/test data from MySQL and propagate
the appropriate pieces into Elastic Search. We've run our test suite in part and in whole
using <a href="https://github.com/cognitect-labs/test-runner">Cognitect's <code>test-runner</code></a> for a
long time as well and we were very pleased to see an "exec function" entry point added
recently -- we've had our own "exec function" entry point for a while that performs
some test setup before invoking the <code>test-runner</code> so this just made our lives a bit easier.</p><p>We've been building (uber) JAR files with <a href="https://github.com/seancorfield/depstar"><code>depstar</code></a>
for quite some time too, and our deployment process to our staging server was also written
in Clojure, uploading JAR files to S3 buckets and then notifying our auto-deploy (bash) scripts
by posting "flag" files to the servers that need to retrieve those JAR files and deploy them.</p><p>We replaced two bash scripts with a single Clojure <code>build.clj</code> script that can run database
migrations, run tests, build uberjars, upload JAR files, and notifying the staging server.
Our first run at this ended up with <code>tools.deps.alpha</code> and all our code on the classpath,
at least for test running, which caused some interesting race conditions, due to the optional
S3 transporter code in <code>tools.deps.alpha</code> performing asynchronous requires of some libraries
that we also use in our tests (including <code>core.async</code>). We knew this wasn't ideal -- the core
team think that running tests should be separate from all the rest and that it's OK to run
multiple commands but I wanted things a bit more integrated and was willing to pay the price:
as a workaround, our build script required the t.d.a S3 transporter namespace to force it to
load upfront, even though we don't use any of that functionality.</p><h2 id="toolsbuild"><code>tools.build</code></h2><p>And then <a href="https://clojure.org/news/2021/07/09/source-libs-builds"><code>tools.build</code> was released</a> on
July 9th, along with enhancements to the Clojure CLI and <code>tools.deps.alpha</code>, and the ability to
install "tools" locally, per-developer, without needing to edit your <code>deps.edn</code> file.</p><blockquote><p>Aside: At this point, I updated both <a href="https://github.com/seancorfield/depstar"><code>depstar</code></a> and <a href="https://github.com/seancorfield/clj-new"><code>clj-new</code></a> to work with the new "tools" functionality, adding <code>:tools/usage</code> to their <code>deps.edn</code> files and updating the documentation to show how to install them under this new system. I also broke <code>depstar</code> up into tasks so that I could expose <code>hf.depstar.api/jar</code> and <code>hf.depstar.api/uber</code> as direct, drop-in replacements for <code>clojure.tools.build.api/jar</code> and <code>clojure.tools.build.api/uber</code> -- because <code>depstar</code> still has a lot of functionality and options that <code>tools.build</code> does not yet have.</p></blockquote><p><code>tools.build</code> provided features that allowed us to simplify our <code>build.clj</code> script and also offered
the possibility of running our tests in an isolated environment, without the pollution of <code>tools.deps.alpha</code>'s
many dependencies: using <code>create-basis</code>, <code>java-command</code>, and <code>process</code> from
<a href="https://clojure.github.io/tools.build/clojure.tools.build.api.html"><code>clojure.tools.build.api</code></a> makes it
fairly easy to run Clojure <code>-main</code> programs with command-line arguments.</p><p>Unfortunately, we relied heavily on <code>-X</code> execution of many of our previously scripted test/build/deploy
functions and we didn't have <code>-main</code> programs for most of those. What we really needed was a variant of
<code>java-command</code> that built a command-line for running "exec functions". The way this is done in the Clojure
CLI is via the <code>exec.jar</code> that is part of its install and a <code>clojure.run.exec</code> namespace, which has a
<code>-main</code> that reads the command-line arguments as EDN and then invokes the specified function with a
hash map of those arguments, including <code>:exec-fn</code>, <code>:exec-args</code>, etc from the project basis under the
specified aliases.</p><p>This wasn't too hard to write, but it involved taking a snapshot of <code>clojure.run.exec</code> under a new name
since it isn't yet a stable API and isn't published as a library. You can see the approach we took in
<a href="https://clojure.atlassian.net/browse/TBUILD-6">TBUILD-6</a> which allows us to easily run <code>-X</code> executions
in subprocesses. Unfortunately, <code>clojure.run.exec</code> in <code>exec.jar</code> has already changed in ways that would
break our workaround (hence the snapshot under a different name). It seems a shame that with all the
work done to support "exec functions" as command-line entry points, <code>tools.build</code> doesn't support that
out of the box. We are happy with our workaround though.</p><p>At this point, we had a <code>build.clj</code> and a <code>:build</code> alias and our entire CI pipeline came down to just:</p><pre><code class="bash">clojure -T:build all-tests-ci
clojure -T:build tag-build-and-upload-all
</code></pre><p>The former is an exec function that runs our "cold start" (described above) and then runs the tests for all our
subprojects, both in subprocesses, and the latter uses <code>process</code> to run some <code>git</code> commands, followed by calls
to <code>depstar</code> as a library, and then calls to our artifact uploader. Our <code>:build</code> alias looks like this:</p><pre><code class="clojure">  :build
  {:paths ["."] ; required to allow -M legacy invocation
   :deps {org.clojure/clojure {:mvn/version "1.11.0-alpha1"}

          io.github.clojure/tools.build {:git/tag "v0.1.6" :git/sha "5636e61"
                                         :exclusions [org.slf4j/slf4j-nop]}
          ;; add depstar for building uberjars:
          com.github.seancorfield/depstar {:git/tag "v2.1.267" :git/sha "1a45f79"
                                           :exclusions [org.slf4j/slf4j-nop]}
          ;; and local build tools:
          worldsingles/build {:local/root "build"}
          poly/base-artifact-uploader-cli {:local/root "bases/artifact-uploader-cli"}
          poly/artifact-uploader {:local/root "components/artifact-uploader"}}
   :ns-default build}
</code></pre><p>As the comment indicates, the <code>:paths</code> entry is there so that we can still invoke <code>build.clj</code> via <code>-M</code> which we
do to support what's left of our legacy <code>build</code> bash script until we retire it (which will probably happen next week).
The local <code>build</code> subproject includes some legacy app support tasks that we run from our new <code>build.clj</code> script
(which will soon be refactored to Polylith <code>bases</code> and <code>components</code>). The <code>artifact-uploader</code> is what I mentioned
above, uploading JAR files to S3.</p><h2 id="footnote-depstar-and-clj-new">Footnote: <code>depstar</code> and <code>clj-new</code></h2><p>Already since <code>tools.build</code> was released, it has had several enhancement releases that add features <code>depstar</code> has had for a while and,
talking to Alex Miller, it's likely that most (or perhaps even all) of <code>depstar</code>'s functionality will be implemented in
the built-in <code>jar</code> and <code>uber</code> tasks over time -- which makes me very happy since I will be able to direct my open source
maintenance energy into other projects!</p><p>I've also observed to a few people that most of what <code>clj-new</code> does for internal templates (<code>app</code>, <code>lib</code>, and <code>template</code>)
could easily be done via <code>clojure.tools.build.api/copy-dir</code> since it supports text substitutions. With <code>create-basis</code>,
<code>java-command</code>, and <code>process</code>, it looks possible to reproduce most of <code>clj-new</code>'s external template functionality as a
very thin wrapper around <code>tools.build</code> as well. My thoughts on this are less well-formed than around <code>depstar</code> but my
hope is that both of my libraries/tools will essentially either go away or be substantially simplified which in turn
should reduce the sense of fragmentation of tools around the CLI and <code>deps.edn</code> and encourage more people to standardize
on the tooling that the core team are carefully producing.</p>
</div>

<div id="post-tags">
    <b>Tags: </b>
    
    <a href="/tags/clojure/">clojure</a>
    
    <a href="/tags/polylith/">polylith</a>
    
    <a href="/tags/tools.build/">tools.build</a>
    
    <a href="/tags/monorepo/">monorepo</a>
    
</div>


    <div id="prev-next">
        
        <a href="/blog/2021/08/02/tools-build/">&laquo; tools.build</a>
        
        
        <a class="right" href="/blog/2021/06/06/deps-edn-monorepo-3/">deps.edn and monorepos III (Polylith) &raquo;</a>
        
    </div>

    
    <div id="disqus_thread"></div>
    <script type="text/javascript">
        var disqus_config = function () {
            this.page.url = "https://corfield.org/blog/2021/07/21/deps-edn-monorepo-4/";
            this.page.identifier = "deps.edn and monorepos IV";
        };
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//seancorfield.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    


</div>

            </div>
        </div>

        <div class="col-md-3">
            <div id="sidebar">
                <h3>About This Blog</h3>
                <p>Sean Corfield, Software Architect, offers his views on the world of software development.</p>
                <p class="smallprint">Masthead image &copy; Vernon Viehe.</p>
                
                
                <div id="recent">
                    <h3>Recent Posts</h3>
                    <ul>
                        
                        <li><a href="/blog/2023/07/15/deps-edn-monorepo-11/">deps.edn and monorepos XI (Polylith)</a></li>
                        
                        <li><a href="/blog/2023/06/30/long-term-funding-3/">Long-Term Funding, Update #3</a></li>
                        
                        <li><a href="/blog/2023/04/30/long-term-funding-2/">Long-Term Funding, Update #2</a></li>
                        
                        <li><a href="/blog/2023/04/16/calva-joyride-portal/">Calva, Joyride, and Portal</a></li>
                        
                        <li><a href="/blog/2023/02/28/long-term-funding-1/">Long-Term Funding, Update #1</a></li>
                        
                    </ul>
                </div>
                
                
                
                <h3>GitHub Repos</h3>
                <iframe src="https://github.com/sponsors/seancorfield/button" title="Sponsor seancorfield" height="35" width="116" style="border: 0;"></iframe>
                <ul id="gh_repos" class="smallprint">
                  <li class="loading">Status updating...</li>
                </ul>
                
                <a href="https://github.com/seancorfield">@seancorfield</a> on GitHub
                
                <script type="text/javascript">
                  $(document).ready(function(){
                      if (!window.jXHR){
                          var jxhr = document.createElement('script');
                          jxhr.type = 'text/javascript';
                          jxhr.src = 'https://corfield.org/js/libs/jXHR.js';
                          var s = document.getElementsByTagName('script')[0];
                          s.parentNode.insertBefore(jxhr, s);
                      }

                      github.showRepos({
                          user: 'seancorfield',
                          count: 6,
                          skip_forks: true,
                          target: '#gh_repos'
                      });
                  });
                </script>
                <script src="https://corfield.org/js/github.js" type="text/javascript"> </script>
                
                
                <div id="tags">
                    <h3>Tags</h3>
                    <ul>
                        
                        <li><a href="/tags/diversity/">diversity</a></li>
                        
                        <li><a href="/tags/strange loop/">strange loop</a></li>
                        
                        <li><a href="/tags/frege/">frege</a></li>
                        
                        <li><a href="/tags/clojure/">clojure</a></li>
                        
                        <li><a href="/tags/polylith/">polylith</a></li>
                        
                        <li><a href="/tags/boot/">boot</a></li>
                        
                        <li><a href="/tags/conferences/">conferences</a></li>
                        
                        <li><a href="/tags/process/">process</a></li>
                        
                        <li><a href="/tags/editors/">editors</a></li>
                        
                        <li><a href="/tags/java/">java</a></li>
                        
                        <li><a href="/tags/joyride/">joyride</a></li>
                        
                        <li><a href="/tags/personal/">personal</a></li>
                        
                        <li><a href="/tags/atom/">atom</a></li>
                        
                        <li><a href="/tags/tools.build/">tools.build</a></li>
                        
                        <li><a href="/tags/calva/">calva</a></li>
                        
                        <li><a href="/tags/windows/">windows</a></li>
                        
                        <li><a href="/tags/monorepo/">monorepo</a></li>
                        
                        <li><a href="/tags/community/">community</a></li>
                        
                        <li><a href="/tags/jdbc/">jdbc</a></li>
                        
                        <li><a href="/tags/honeysql/">honeysql</a></li>
                        
                        <li><a href="/tags/portal/">portal</a></li>
                        
                        <li><a href="/tags/clojurists together/">clojurists together</a></li>
                        
                        <li><a href="/tags/clojure-doc.org/">clojure-doc.org</a></li>
                        
                        <li><a href="/tags/conj/">conj</a></li>
                        
                        <li><a href="/tags/leiningen/">leiningen</a></li>
                        
                        <li><a href="/tags/javascript/">javascript</a></li>
                        
                        <li><a href="/tags/observability/">observability</a></li>
                        
                        <li><a href="/tags/clojure-clr/">clojure-clr</a></li>
                        
                        <li><a href="/tags/presentations/">presentations</a></li>
                        
                        <li><a href="/tags/new relic/">new relic</a></li>
                        
                        <li><a href="/tags/vs code/">vs code</a></li>
                        
                        <li><a href="/tags/open source/">open source</a></li>
                        
                    </ul>
                </div>
                
            </div>
        </div>
    </div>
    <footer>Copyright &copy; 2023 Sean Corfield
        <p style="text-align: center;">Powered by <a href="https://cryogenweb.org">Cryogen</a></p></footer>
</div>
<script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.0/js/bootstrap.min.js"></script>
<script src="/js/highlight.pack.js" type="application/javascript"></script>
<script>hljs.initHighlightingOnLoad();</script>


</body>
</html>
