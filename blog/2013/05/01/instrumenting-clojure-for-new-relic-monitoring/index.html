<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
    <meta charset="utf-8"/>
    <title>An Architect&#39;s View: Instrumenting Clojure for New Relic Monitoring</title>
    
<meta name="keywords" content="diversity,frege,clojure,boot,conferences,process,java,community,jdbc,conj,leiningen,javascript,presentations">

<meta name="description" content="We&#39;ve recently started evaluating the New Relic monitoring service at World Singles and when you use their Java agent with your web application container, you can get a lot of information about what&#39;s going on inside your application (JVM activity, database activity, external HTTP calls, web transaction traces). For a CFML application tho&#39;, all you tend to get in the web transaction traces is the Servlet entry point, some JDBC SQL reports, and some of the low-level Java libraries (if you&#39;re lucky!).However, we have a mixture of CFML and Clojure, running on the free open source Railo server so I thought it might be possible to somehow instrument the Clojure code to enable more visibility into our application traces.">

<meta property="og:description" content="We&#39;ve recently started evaluating the New Relic monitoring service at World Singles and when you use their Java agent with your web application container, you can get a lot of information about what&#39;s going on inside your application (JVM activity, database activity, external HTTP calls, web transaction traces). For a CFML application tho&#39;, all you tend to get in the web transaction traces is the Servlet entry point, some JDBC SQL reports, and some of the low-level Java libraries (if you&#39;re lucky!).However, we have a mixture of CFML and Clojure, running on the free open source Railo server so I thought it might be possible to somehow instrument the Clojure code to enable more visibility into our application traces.">

<meta property="og:url" content="https://corfield.org/blog/2013/05/01/instrumenting-clojure-for-new-relic-monitoring/" />
<meta property="og:title" content="Instrumenting Clojure for New Relic Monitoring" />
<meta property="og:type" content="article" />

    <link rel="canonical" href="https://corfield.org/blog/2013/05/01/instrumenting-clojure-for-new-relic-monitoring/">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="//fonts.googleapis.com/css?family=Alegreya:400italic,700italic,400,700" rel="stylesheet"
          type="text/css">
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.0/css/bootstrap.min.css">
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.7.0/styles/default.min.css">
    <link href="/css/screen.css?1" rel="stylesheet" type="text/css" />
    <script src="//code.jquery.com/jquery-1.11.0.min.js"></script>
</head>
<body>

<nav class="navbar navbar-default">
    <div class="container">
        <div class="navbar-header right">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">An Architect&#39;s View</a>
        </div>
        <div id="navbar" class="navbar-collapse collapse right">
            <ul class="nav navbar-nav navbar-right">
                <li ><a href="/">Home</a></li>
                <li
                ><a href="/archives/">Archives</a></li>
                
                <li
                >
                <a href="/pages/presentations/">Presentations</a>
                </li>
                
                <li><a href="/atom.xml">RSS</a></li>
            </ul>
        </div><!--/.nav-collapse -->
    </div><!--/.container-fluid -->
</nav>


<div class="container">


    <div class="row">
        <div class="col-lg-9">
            <div id="content">
                
<div id="post">
    <div class="post-header">
    <div id="post-meta" class="row">
        <div class="col-lg-6">May 1, 2013</div>
        
    </div>
    <h2>Instrumenting Clojure for New Relic Monitoring</h2>
</div>
<div>
    
    <p>We've recently started evaluating the <a href="http://newrelic.com/">New Relic monitoring service</a> at World Singles and when you use their Java agent with your web application container, you can get a lot of information about what's going on inside your application (JVM activity, database activity, external HTTP calls, web transaction traces).<!-- more --> For a CFML application tho', all you tend to get in the web transaction traces is the Servlet entry point, some JDBC SQL reports, and some of the low-level Java libraries (if you're lucky!).</p><p>However, we have a mixture of CFML and Clojure, running on the <a href="http://www.getrailo.org">free open source Railo server</a> so I thought it might be possible to somehow instrument the Clojure code to enable more visibility into our application traces.</p><p>This <a href="http://blog.newrelic.com/2012/11/13/setting-up-custom-instrumentation-using-the-new-relic-java-agent/">New Relic blog post talks about custom instrumentation</a> and shows how you can use method annotations in Java to make specific function calls show up in web transaction traces. (The New Relic documentation, accessible from their monitoring console, provides more detail)</p><p>In Java (approximately):</p><pre><code>import com.newrelic.api.agent.Trace;

public class Thing {

    @Trace
    public void someMethod() {
        ...
    }

}
</code></pre><p>So how do you do the same thing in Clojure? Annotations have been supported for quite a while in Clojure but they're very poorly documented and they require some specialized code.</p><p>Let's suppose you have this Clojure code:</p><pre><code>(ns my-project.stuff)

(defn some-func [x y z] ...)

(defn another-fn [a b] ...)
</code></pre><p>We want to annotate both of these functions so they show up in New Relic web transaction traces. You can add annotations in a <code>deftype</code> so we have to transform our code quite a bit. First off, you'll need the New Relic JAR as a dependency in <code>project.clj</code>:</p><pre><code>  :dependencies
    [...
     [com.newrelic.agent.java/newrelic-api "3.10.0"]
     ...]
</code></pre><p>Check <a href="http://search.maven.org/#search%7Cga%7C1%7Cnewrelic-api">Maven Central</a> for the latest version! <em>As of September 26th, 2014, it was <code>3.10.0</code>.</em></p><p>Then you need to import the <code>Trace</code> annotation:</p><pre><code>(ns my-project.stuff
  (:import com.newrelic.api.agent.Trace))
</code></pre><p>Since we need to use <code>deftype</code> we need to define an interface type for the functions we want to instrument. We also need to use Java-compatible names. Here's a first cut:</p><pre><code>(definterface INR
  (some_func [x y z])
  (another_fn [a b]))
</code></pre><p>Now we can define the implementation type with the annotations. Then we'll need to expose a Clojure API based on that. Let's start by renaming our existing implementations and making them private, so we can call them from the <code>deftype</code> with minimal code changes:</p><pre><code>(defn- some-func* [x y z] ...)

(defn- another-fn* [a b] ...)
</code></pre><p>Now we can write our <code>deftype</code> with annotations:</p><pre><code>(deftype NR []
  INR
  ;; @Trace maps to Trace {} metadata:
  (^{Trace {}} some_func  [_ x y z] (some-func* x y z))
  (^{Trace {}} another_fn [_ a b]   (another-fn* a b)))
</code></pre><p>Here we have an implementation - <code>NR</code> - of our interface - <code>INR</code> - which provides the two methods. Note that they ignore their first argument (<code>this</code>) because the object type is just an artifact of <code>deftype</code> for us to add the annotations. Finally, we can reimplement our original API in terms of the new type. In order to do that, we need an instance of our type, and to avoid classloader issues, we'll create a new instance in each call. <em>In my original blog post I suggested using a private singleton but later discovered that caused problems with classloaders sometimes.</em></p><p>And finally here is our original API reimplemented in a traceable way:</p><pre><code>(defn some-func  [x y z] (.some_func (NR.) x y z))

(defn another-fn [a b]   (.another_fn (NR.) a b))
</code></pre><p>Now you just need to start your web application container with the JVM option <code>-javaagent:/path/to/newrelic.jar</code> (which is your licensed JAR file downloaded from your monitoring console, not the one pulled in by Leiningen based on the dependency we added above!).</p><p>When you drill into web transaction traces, you should see <code>my_project.stuff.NR.some_func</code> and <code>my_project.stuff.NR.another_fn</code> entries in it!</p>
</div>

<div id="post-tags">
    <b>Tags: </b>
    
    <a href="/tags/clojure/">clojure</a>
    
</div>


    <div id="prev-next">
        
        <a href="/blog/2013/09/22/the-strange-loop-2013/">&laquo; The Strange Loop 2013</a>
        
        
    </div>

    
    <div id="disqus_thread"></div>
    <script type="text/javascript">
        var disqus_config = function () {
            this.page.url = "https://corfield.org/blog/2013/05/01/instrumenting-clojure-for-new-relic-monitoring/";
            this.page.identifier = "Instrumenting Clojure for New Relic Monitoring";
        };
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//seancorfield.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    


</div>

            </div>
        </div>

        <div class="col-md-3">
            <div id="sidebar">
                <h3>About This Blog</h3>
                <p>Sean Corfield, Software Architect, offers his views on the world of software development.</p>
                <p class="smallprint">Masthead image &copy; Vernon Viehe.</p>
                
                
                <div id="recent">
                    <h3>Recent Posts</h3>
                    <ul>
                        
                        <li><a href="/blog/2020/11/24/talks-clojures-superpower/">Talks: Clojure&#39;s Superpower</a></li>
                        
                        <li><a href="/blog/2020/11/09/vscode-clover/">VS Code and Clover</a></li>
                        
                        <li><a href="/blog/2020/10/25/next-jdbc/">next.jdbc Compendium II</a></li>
                        
                        <li><a href="/blog/2020/05/23/next-jdbc/">next.jdbc Compendium</a></li>
                        
                        <li><a href="/blog/2019/12/31/releases/">Happy New Releases!</a></li>
                        
                    </ul>
                </div>
                
                
                <h3>Latest Tweets</h3>
                <div id="tweets">
                  <a class="twitter-timeline" data-dnt="true" href="https://twitter.com/seancorfield"  data-widget-id="480131406987673601"  data-link-color="#1863a1" data-tweet-limit="4" data-chrome="noheader nofooter transparent noscrollbar">Tweets by @seancorfield</a><br/>
                  <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+"://platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
                </div>
                
                  <a href="http://twitter.com/seancorfield" class="twitter-follow-button" data-show-count="true">Follow @seancorfield</a>
                
                
                
                <h3>GitHub Repos</h3>
                <iframe src="https://github.com/sponsors/seancorfield/button" title="Sponsor seancorfield" height="35" width="116" style="border: 0;"></iframe>
                <ul id="gh_repos" class="smallprint">
                  <li class="loading">Status updating...</li>
                </ul>
                
                <a href="https://github.com/seancorfield">@seancorfield</a> on GitHub
                
                <script type="text/javascript">
                  $(document).ready(function(){
                      if (!window.jXHR){
                          var jxhr = document.createElement('script');
                          jxhr.type = 'text/javascript';
                          jxhr.src = 'https://corfield.org/js/libs/jXHR.js';
                          var s = document.getElementsByTagName('script')[0];
                          s.parentNode.insertBefore(jxhr, s);
                      }

                      github.showRepos({
                          user: 'seancorfield',
                          count: 6,
                          skip_forks: true,
                          target: '#gh_repos'
                      });
                  });
                </script>
                <script src="https://corfield.org/js/github.js" type="text/javascript"> </script>
                
                
                <div id="tags">
                    <h3>Tags</h3>
                    <ul>
                        
                        <li><a href="/tags/diversity/">diversity</a></li>
                        
                        <li><a href="/tags/frege/">frege</a></li>
                        
                        <li><a href="/tags/clojure/">clojure</a></li>
                        
                        <li><a href="/tags/boot/">boot</a></li>
                        
                        <li><a href="/tags/conferences/">conferences</a></li>
                        
                        <li><a href="/tags/process/">process</a></li>
                        
                        <li><a href="/tags/java/">java</a></li>
                        
                        <li><a href="/tags/community/">community</a></li>
                        
                        <li><a href="/tags/jdbc/">jdbc</a></li>
                        
                        <li><a href="/tags/conj/">conj</a></li>
                        
                        <li><a href="/tags/leiningen/">leiningen</a></li>
                        
                        <li><a href="/tags/javascript/">javascript</a></li>
                        
                        <li><a href="/tags/presentations/">presentations</a></li>
                        
                    </ul>
                </div>
                
            </div>
        </div>
    </div>
    <footer>Copyright &copy; 2021 Sean Corfield
        <p style="text-align: center;">Powered by <a href="https://cryogenweb.org">Cryogen</a></p></footer>
</div>
<script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.0/js/bootstrap.min.js"></script>
<script src="/js/highlight.pack.js" type="application/javascript"></script>
<script>hljs.initHighlightingOnLoad();</script>


</body>
</html>
